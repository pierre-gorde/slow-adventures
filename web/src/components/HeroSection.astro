---
import { Image } from 'astro:assets';
import ScrollHint from './ScrollHint.astro';

interface Props {
  posterSrc: ImageMetadata;
  videoSrc: string;
  title: string;
  subtitle: string;
}

const { posterSrc, videoSrc, title, subtitle } = Astro.props;
---

<section class="hero" aria-label="Section d'accueil — introduction visuelle">
  <div class="hero__media">
    <Image
      src={posterSrc}
      alt="Paysage d'Amérique latine"
      class="hero__poster"
      widths={[768, 1440, 2880]}
      sizes="100vw"
      loading="eager"
      decoding="async"
    />
    <video
      class="hero__video"
      autoplay
      muted
      playsinline
      aria-hidden="true"
      data-src={videoSrc}
    >
    </video>
  </div>
  <div class="hero__overlay"></div>
  <div class="hero__content">
    <h1 class="hero__title font-serif text-white">{title}</h1>
    <p class="hero__subtitle font-sans text-white">{subtitle}</p>
  </div>
  <ScrollHint />
</section>

<style>
  .hero {
    position: relative;
    width: 100%;
    height: 100vh;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .hero__media {
    position: absolute;
    inset: 0;
    z-index: 0;
  }

  .hero__poster {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
  }

  .hero__video {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    opacity: 0;
    transition: opacity 1s ease-in-out;
  }

  .hero__video.is-playing {
    opacity: 1;
  }

  .hero__overlay {
    position: absolute;
    inset: 0;
    z-index: 1;
    background-color: rgba(44, 40, 37, 0.8);
  }

  .hero__content {
    position: relative;
    z-index: 2;
    text-align: center;
    padding: 0 1.5rem;
    max-width: 100%;
  }

  .hero__title {
    font-size: clamp(2.5rem, 5vw, 4.5rem);
    font-weight: 600;
    line-height: 1.2;
    margin: 0;
  }

  .hero__subtitle {
    font-size: clamp(1rem, 2vw, 1.5rem);
    font-weight: 400;
    margin-top: 1rem;
    opacity: 0.9;
  }

  @media (prefers-reduced-motion: reduce) {
    .hero__video {
      transition: none;
    }
  }
</style>

<script>
  function initHero() {
    const video = document.querySelector<HTMLVideoElement>('.hero__video');
    if (!video) return;

    const saveData =
      (navigator as unknown as { connection?: { saveData?: boolean } })
        .connection?.saveData === true;
    const reducedMotion = window.matchMedia(
      '(prefers-reduced-motion: reduce)'
    ).matches;

    if (saveData || reducedMotion) {
      video.remove();
      return;
    }

    const src = video.dataset.src ?? '';
    if (!src) return;

    const source = document.createElement('source');
    source.src = src;
    source.type = 'video/mp4';
    video.appendChild(source);
    video.load();
    video
      .play()
      .then(() => {
        video.classList.add('is-playing');
      })
      .catch(() => {
        video.classList.remove('is-playing');
      });

    // Smooth loop: short fade-out near end, quick fade-in on restart
    const FADE_OUT = 0.8;
    const FADE_IN = 0.5;
    let looping = false;

    video.addEventListener('timeupdate', () => {
      if (
        !looping &&
        video.duration &&
        video.currentTime > video.duration - FADE_OUT
      ) {
        looping = true;
        video.style.transition = `opacity ${FADE_OUT}s ease-out`;
        video.style.opacity = '0.3';
      }
    });

    video.addEventListener('ended', () => {
      video.currentTime = 0;
      video.play().catch(() => {});
      video.style.transition = `opacity ${FADE_IN}s ease-in`;
      video.style.opacity = '1';
      looping = false;
    });
  }

  initHero();

  // Resume video when page regains visibility (bfcache restore, tab switch on mobile)
  document.addEventListener('visibilitychange', function () {
    if (document.visibilityState !== 'visible') return;
    const video = document.querySelector<HTMLVideoElement>('.hero__video');
    if (!video || !video.paused || !video.querySelector('source')) return;
    video
      .play()
      .then(() => {
        video.classList.add('is-playing');
      })
      .catch(() => {});
  });
</script>

<script>
  import { gsap, ScrollTrigger } from '../lib/gsap';

  function initParallax() {
    const hero = document.querySelector<HTMLElement>('.hero');
    const title = document.querySelector<HTMLElement>('.hero__title');
    if (!hero || !title) return;

    gsap.matchMedia().add('(prefers-reduced-motion: no-preference)', () => {
      gsap.to(title, {
        y: -50,
        ease: 'none',
        scrollTrigger: {
          trigger: hero,
          start: 'top top',
          end: 'bottom top',
          scrub: 1,
        },
      });

      return () => {
        ScrollTrigger.getAll()
          .filter((st) => st.trigger === hero)
          .forEach((st) => st.kill());
      };
    });
  }

  initParallax();

  // Recalculate ScrollTrigger positions on bfcache restore (mobile browsers)
  window.addEventListener('pageshow', (event) => {
    if ((event as PageTransitionEvent).persisted) {
      ScrollTrigger.refresh();
    }
  });
</script>

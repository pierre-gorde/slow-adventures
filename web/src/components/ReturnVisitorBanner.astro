---
// ReturnVisitorBanner.astro — Toast flottant visiteur retour
// Composant .astro avec <script> natif (pas de client:load)
---

<div
  id="return-visitor-banner"
  role="status"
  aria-live="polite"
  class="sa-toast fixed top-4 left-1/2 z-50 max-w-sm w-[calc(100%-2rem)] rounded-xl bg-creme/90 backdrop-blur-md text-warm-black font-sans px-5 py-3 text-center text-sm md:text-base shadow-lg cursor-pointer"
  hidden
>
  <span id="return-visitor-message"></span>
</div>

<style>
  .sa-toast {
    transform: translateX(-50%) translateY(-120%);
    opacity: 0;
    transition:
      transform 400ms cubic-bezier(0.34, 1.56, 0.64, 1),
      opacity 400ms ease-out;
  }

  .sa-toast-visible {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  .sa-toast-exit {
    transform: translateX(-50%) translateY(-120%);
    opacity: 0;
    transition:
      transform 300ms ease-in,
      opacity 300ms ease-in;
  }

  @media (prefers-reduced-motion: reduce) {
    .sa-toast,
    .sa-toast-exit {
      transition: none;
    }
  }
</style>

<script>
  import {
    sequentialMessages,
    rotatingMessages,
  } from '../data/returnVisitorMessages';

  const banner = document.getElementById('return-visitor-banner');
  const messageEl = document.getElementById('return-visitor-message');

  if (banner && messageEl) {
    try {
      const visited = localStorage.getItem('sa_visited');

      if (!visited) {
        // Premier visiteur — stocker flags, pas de banner
        localStorage.setItem('sa_visited', 'true');
        localStorage.setItem('sa_visit_count', '1');
        localStorage.setItem(
          'sa_first_visit_date',
          new Date().toISOString()
        );
      } else {
        // Visiteur retour — incrémenter compteur
        const count =
          parseInt(localStorage.getItem('sa_visit_count') ?? '1', 10) + 1;
        localStorage.setItem('sa_visit_count', String(count));

        // Vérifier si déjà dismiss cette session
        if (!sessionStorage.getItem('sa_banner_dismissed')) {
          // Sélectionner message selon le nombre de visites
          let message: string;
          if (count >= 2 && count <= 10) {
            message = sequentialMessages[count - 2];
          } else {
            message =
              rotatingMessages[
                Math.floor(Math.random() * rotatingMessages.length)
              ];
          }
          messageEl.textContent = message;

          // Afficher le toast immédiatement
          banner.removeAttribute('hidden');
          void banner.offsetHeight;
          banner.classList.add('sa-toast-visible');

          // Fonction dismiss
          let dismissed = false;
          const dismiss = () => {
            if (dismissed) return;
            dismissed = true;
            banner.classList.remove('sa-toast-visible');
            banner.classList.add('sa-toast-exit');
            setTimeout(() => {
              banner.setAttribute('hidden', '');
            }, 300);
            sessionStorage.setItem('sa_banner_dismissed', 'true');
          };

          // Auto-dismiss après 5 secondes + dismiss au clic/Escape
          setTimeout(dismiss, 5000);
          banner.addEventListener('click', dismiss, { once: true });
          document.addEventListener(
            'keydown',
            (e) => {
              if (e.key === 'Escape') dismiss();
            },
            { once: true }
          );
        }
      }
    } catch (error) {
      console.error('[slow-adventures]', error);
    }
  }
</script>

---
const calendlyUrl = import.meta.env.PUBLIC_CALENDLY_URL;
---

<!-- Calendly popup widget — CSS + JS chargés async -->
<link
  rel="preload"
  href="https://assets.calendly.com/assets/external/widget.css"
  as="style"
  onload="this.rel='stylesheet'"
/>
<noscript>
  <link
    rel="stylesheet"
    href="https://assets.calendly.com/assets/external/widget.css"
  />
</noscript>
<script
  is:inline
  src="https://assets.calendly.com/assets/external/widget.js"
  async></script>

<div id="calendly-config" data-calendly-url={calendlyUrl} hidden></div>

<script>
  import { trackCalendlyComplete } from '../lib/analytics';

  const CALENDLY_URL =
    document.getElementById('calendly-config')?.dataset.calendlyUrl ?? '';

  type CalendlyWindow = Window & {
    Calendly?: {
      initPopupWidget: (opts: { url: string }) => void;
    };
  };

  function waitForCalendly(timeout = 5000): Promise<boolean> {
    const win = window as unknown as CalendlyWindow;
    if (win.Calendly) return Promise.resolve(true);

    return new Promise((resolve) => {
      const start = Date.now();
      const check = setInterval(() => {
        if (win.Calendly) {
          clearInterval(check);
          resolve(true);
        } else if (Date.now() - start > timeout) {
          clearInterval(check);
          resolve(false);
        }
      }, 100);
    });
  }

  // Interception clics sur [data-calendly-trigger] → popup Calendly
  document
    .querySelectorAll<HTMLElement>('[data-calendly-trigger]')
    .forEach((trigger) => {
      trigger.addEventListener('click', async (e) => {
        e.preventDefault();

        const ready = await waitForCalendly();
        const win = window as unknown as CalendlyWindow;

        if (ready && win.Calendly) {
          win.Calendly.initPopupWidget({
            url: CALENDLY_URL + '?hide_gdpr_banner=1',
          });
          document.dispatchEvent(new CustomEvent('sa:modal-open'));
        } else {
          window.open(CALENDLY_URL, '_blank');
        }
      });
    });

  // Tracking réservation complète + fermeture popup
  window.addEventListener('message', (e) => {
    if (e.data?.event === 'calendly.event_scheduled') {
      trackCalendlyComplete();
    }
    if (
      e.data?.event === 'calendly.close_event' ||
      e.data?.event === 'calendly.event_scheduled'
    ) {
      document.dispatchEvent(new CustomEvent('sa:modal-close'));
    }
  });
</script>

---
const calendlyUrl = import.meta.env.PUBLIC_CALENDLY_URL;
---

<!-- Calendly popup widget — CSS + JS chargés async -->
<link
  rel="preload"
  href="https://assets.calendly.com/assets/external/widget.css"
  as="style"
  onload="this.rel='stylesheet'"
/>
<noscript>
  <link
    rel="stylesheet"
    href="https://assets.calendly.com/assets/external/widget.css"
  />
</noscript>
<script
  is:inline
  src="https://assets.calendly.com/assets/external/widget.js"
  async></script>

<div id="calendly-config" data-calendly-url={calendlyUrl} hidden></div>

<script>
  import { trackCalendlyComplete } from '../lib/analytics';

  const CALENDLY_URL =
    document.getElementById('calendly-config')?.dataset.calendlyUrl ?? '';

  // Interception clics sur [data-calendly-trigger] → popup Calendly
  document
    .querySelectorAll<HTMLElement>('[data-calendly-trigger]')
    .forEach((trigger) => {
      trigger.addEventListener('click', (e) => {
        e.preventDefault();

        // Attendre que le script Calendly soit chargé
        const win = window as unknown as {
          Calendly?: {
            initPopupWidget: (opts: { url: string }) => void;
          };
        };

        if (win.Calendly) {
          win.Calendly.initPopupWidget({
            url: CALENDLY_URL + '?hide_gdpr_banner=1',
          });
          document.dispatchEvent(new CustomEvent('sa:modal-open'));
        } else {
          // Fallback : ouvrir dans un nouvel onglet
          window.open(CALENDLY_URL, '_blank');
        }
      });
    });

  // Tracking réservation complète + fermeture popup
  window.addEventListener('message', (e) => {
    if (e.data?.event === 'calendly.event_scheduled') {
      trackCalendlyComplete();
    }
    if (
      e.data?.event === 'calendly.close_event' ||
      e.data?.event === 'calendly.event_scheduled'
    ) {
      document.dispatchEvent(new CustomEvent('sa:modal-close'));
    }
  });
</script>
